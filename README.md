# etcd-cluster
<!-- TOC -->
## cfssl-etcd-cluster
<!-- /TOC -->
### author: yinshixiong
### 用于安装Etcd服务
### 安装前需要将数组脚本内ip进行替换，如果多节点适当修改配置信息
### 只需要修改globalClusterInfo.sh
- [server_arrays数组](用于录入IP地址)
  - [etcd1 etcd2 etcd3 etcd4 etcd5]
  - [etcd1 etcd2 etcd3]
  - [etcd1]
## 主要组件版本
| 组件 | 版本 |
| --- | --- | 
| etcd | 3.3.13 |
| etcdctl | 3.3.13 |
| cfssl | 1.2.0 |
| cfssl-certinfo | 1.2.0 |
| cfssljson | 1.2.0 |


### [cfsslExtendCluster目录结构]
  - [cleanRootCA.sh] [清理所有证书,慎用]
  - [installCfsslCommand.sh] [安装cfssl工具]
  - [createAllCert.sh] [创建所有服务器证书]
  - [extandCluster.sh] [-A调用createAllCert.sh创建所有证书]
  
    
### [extandCluster.sh][证书生成脚本]
    
    `sh extandCluster.sh -A创建所有证书`
    
    `sh extandCluster.sh -C 生成ROOTCA证书`
    
    `sh extandCluster.sh -D 生成DOMAINROOTCA证书`
    
    `sh extandCluster.sh -s servername -K 生成web服务端证书`
    
    `sh extandCluster.sh -s servername -F nginxCert路径【绝对】生成HTTPS Nginx配置 http自动跳转HTTPS`
    
    `sh extandCluster.sh -a peer-id-num -b peerHostIpaddr -c 生成单独的peer证书`
    
    `sh extandCluster.sh -L 清理证书,清理前会备份ssl到/opt/下`
    
    `sh extandCluster.sh -N 生成客户端证书,无IP绑定`
    
    `sh extandCluster.sh -B client-IP 生成客户端证书,IP绑定`
    
    `sh extandCluster.sh -S server-IP -I server_id -G 生成单独扩展服务端证书,IP绑定`
    
    `sh extandCluster.sh -P 检查所有证书绑定的HOST`
  - [globalClusterInfo.sh]
  	`配置证书服务器IP`
	- [clusterArray]
	-- [etcd1,etcd2,etcd3]
	-- [etcd1,etcd2,etcd3,etcd4,etcd5]
	-- [etcd1]
	-- 配置/etc/hosts写入映射信息

### [安装etcd服务]

	- [目录结构]
		- bin  
			- [安装脚本]
				- main.sh 
					- [入口]
				- appendHosts.sh
				- createServiceCert.sh
				- globalClusterInfo.sh
				- installCfsslCommand.sh 
				- main.sh.bak
				- readme.txt
		- cfsslExtendCluster
		- conf 
		- crt
		- service 
		- tools

### [main.sh]
	----------------------------------------------------------------------------------------------------------------------------
							帮助信息:
	----------------------------------------------------------------------------------------------------------------------------
	[xxxx-xx-xx 10:14:09] [ERROR] [安装3个节点时候需要server_array=3个节点IP]
	[xxxx-xx-xx 10:14:09] [ERROR] [安装5个节点时候需要server_array=5个节点IP]
	------------------------------------------------------------------------------------------------------------
	1. bash main.sh -a etcd1 安装etcd1节点[带证书]
	------------------------------------------------------------------------------------------------------------
	2. bash main.sh -b etcd2 安装etcd2节点[带证书]
	------------------------------------------------------------------------------------------------------------
	3. bash main.sh -c etcd3 安装etcd3节点[带证书]
	------------------------------------------------------------------------------------------------------------
	4. bash main.sh -f etcd4 安装etcd4节点[带证书]
	------------------------------------------------------------------------------------------------------------
	5. bash main.sh -l etcd5 安装etcd5节点[带证书]
	------------------------------------------------------------------------------------------------------------
	1. bash main.sh -x etcd1 安装etcd1节点[不带证书]
	------------------------------------------------------------------------------------------------------------
	2. bash main.sh -y etcd2 安装etcd2节点[不带证书]
	------------------------------------------------------------------------------------------------------------
	3. bash main.sh -z etcd3 安装etcd3节点[不带证书]
	------------------------------------------------------------------------------------------------------------
	4. bash main.sh -m etcd4 安装etcd4节点[不带证书]
	------------------------------------------------------------------------------------------------------------
	5. bash main.sh -n etcd5 安装etcd5节点[不带证书]
	------------------------------------------------------------------------------------------------------------
	1. bash main.sh -G 获取etcd member列表[带证书]
	------------------------------------------------------------------------------------------------------------
	2. bash main.sh -S 获取etcd cluster-health[带证书]
	------------------------------------------------------------------------------------------------------------
	3. bash main.sh -A etcd节点名称 -U url 添加节点[带证书] example: bash install_service.sh -A etcd3 -U https://10.0.0.1:2380
	------------------------------------------------------------------------------------------------------------
	4. bash main.sh -K 移除etcd member[带证书]
	------------------------------------------------------------------------------------------------------------
	5. bash main.sh -L 创建alias快捷命令[带证书]
	------------------------------------------------------------------------------------------------------------
	6. bash main.sh -p 2/3[api version] -B 10(清理多少天前的备份) 备份服务[带证书]
	------------------------------------------------------------------------------------------------------------
	7. bash main.sh -p 3 -w [备份db文件] -N [新数据目录] -R 使用api version3 恢复备份，请注意如果是集群整体迁移，需要在每个节点上执行,切需要指定节点名称[带证书]
	------------------------------------------------------------------------------------------------------------
	8. bash main.sh -j etcd1 安装单节点,[带证书]
	------------------------------------------------------------------------------------------------------------
	9. bash main.sh -g 获取etcd member列表[不带证书]
	------------------------------------------------------------------------------------------------------------
	10. bash main.sh -s 获取etcd cluster-health[不带证书]
	------------------------------------------------------------------------------------------------------------
	11. bash main.sh -e etcd节点名称 -u url 添加节点[不带证书]
	------------------------------------------------------------------------------------------------------------
	12. bash main.sh -J etcd1 安装单节点,不带证书
	------------------------------------------------------------------------------------------------------------
	13. bash main.sh -p 2/3[api version] -v 10(清理多少天前的备份) 备份服务[不带证书]
	------------------------------------------------------------------------------------------------------------
	14. bash main.sh -p 3 -w [备份db文件] -N [新数据目录] -V 节点名称[etcd1..n],使用api version3 恢复备份，请注意如果是集群整体迁移，需要在每个节点上执行,切需要指定节点名称[不带证书]
	------------------------------------------------------------------------------------------------------------
	15. bash main.sh -k 移除etcd member[带证书]
	------------------------------------------------------------------------------------------------------------
	16. bash main.sh -I 启动服务[带证书]
	------------------------------------------------------------------------------------------------------------
	17. bash main.sh -i 停止服务[带证书]
	------------------------------------------------------------------------------------------------------------
	18. bash main.sh -h 查看帮助信息
	------------------------------------------------------------------------------------------------------------
	19. bash main.sh -r 移除etcd服务和数据目录[谨慎操作]
	------------------------------------------------------------------------------------------------------------
